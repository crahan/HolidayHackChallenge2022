---
icon: octicons/file-zip-16
---

# Boria PCAP Mining

**Difficulty**: :fontawesome-solid-star::fontawesome-regular-star::fontawesome-regular-star::fontawesome-regular-star::fontawesome-regular-star:<br/>
**Direct link**: [boriaArtifacts.zip](https://storage.googleapis.com/hhc22_player_assets/boriaArtifacts.zip)


## Objective

!!! question "Request"
    Use [the artifacts](https://storage.googleapis.com/hhc22_player_assets/boriaArtifacts.zip) from Alabaster Snowball to analyze this attack on the Boria mines. Most of the traffic to this site is nice, but one IP address is being naughty! Which is it? Visit Sparkle Redberry in the Web Ring for hints.

??? quote "Alabaster Snowball"
    Hey there! I'm Alabaster Snowball<br/>
    And I have to say, I'm a bit distressed.<br/>
    I was working with the dwarves and their Boria mines, and I found some disturbing activity!<br/>
    Looking through [these artifacts](https://storage.googleapis.com/hhc22_player_assets/boriaArtifacts.zip), I think something naughty's going on.<br/>
    Can you please take a look and answer a few questions for me?<br/>
    First, we need to know where the attacker is coming from.<br/>
    If you haven't looked at Wireshark's Statistics menu, this might be a good time!


## Hints

??? hint "Wireshark Top Talkers"
    The victim web server is 10.12.42.16. Which host is the next [top talker](https://protocoholic.com/2018/05/24/wireshark-how-to-identify-top-talkers-in-network/)?

??? hint "Wireshark String Searching"
    The site's login function is at `/login.html`. Maybe start by [searching](https://www.wireshark.org/docs/wsug_html_chunked/ChWorkFindPacketSection.html) for a *string*.

??? hint "Status Codes"
    With forced browsing, there will be many 404 status codes returned from the web server. Look for 200 codes in that group of 404s. This one can be completed with the PCAP or the log file.

??? hint "Instance Metadata Service"
    AWS uses a specific IP address to access [IMDS](https://www.sans.org/blog/cloud-instance-metadata-services-imds-/), and that IP only appears twice in this PCAP.


## Solution

### Naughty IP

!!! question "Question"
    Use [the artifacts](https://storage.googleapis.com/hhc22_player_assets/boriaArtifacts.zip) from Alabaster Snowball to analyze this attack on the Boria mines. Most of the traffic to this site is nice, but one IP address is being naughty! Which is it? Visit Sparkle Redberry in the Tolkien Ring for hints.

Unzip `boriaArtifacts.zip` and load the `victim.pcap` into Wireshark. Go to Statistics > Conversations > IPv4 and sort by the *Packets* column. This should show that 18.222.86.32 was the most chatty external host. We confirm this observation using `grep 18.222.86.32 boriaArtifacts/weberror.log` as this will return a large amount of requests to `login.html` and random URL paths.

!!! done "Answer"
    18.222.86.32

??? quote "Alabaster Snowball"
    Aha, you found the naughty actor! Next, please look into the account brute force attack.
    You can focus on requests to /login.html~


### Credential Mining

!!! question "Question"
    The first attack is a [brute force](https://owasp.org/www-community/attacks/Brute_force_attack) login. What's the first username tried?

Use `http && ip.src == 18.222.86.32` as a display filter in Wireshark and select the first POST request. The HTML Form URL Encoded data indicates the username and password that were tried are *alice* and *philip*.

!!! done "Answer"
    alice

??? quote "Alabaster Snowball"
    Alice? I totally expected Eve! Well how about forced browsing? What's the first URL path they found that way?<br/>
    The misses will have HTTP status code 404 and, in this case, the successful guesses return 200.


### 404 FTW

!!! question "Question"
    The next attack is [forced browsing](https://owasp.org/www-community/attacks/Forced_browsing) where the naughty one is guessing URLs. What's the first successful URL path in this attack?

Grep the web error logs using `grep 18.222.86.32 boriaArtifacts/weberror.log | grep 200 | grep -v 404 | grep -v login.html` to find all the legitimate requests to pages that are not `login.html`. The first entry that comes up is a GET request to `/proc`.

!!! done "Answer"
    `/proc`

??? quote "Alabaster Snowball"
    Great! Just one more challenge! It looks like they made the server pull credentials from IMDS. What URL was forced?<br/>
    AWS uses a specific IP address for IMDS lookups. Searching for that in the PCAP should get you there quickly.


### IMDS, XXE, and Other Abbreviations

!!! question "Question"
    The last step in this attack was to use [XXE](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing) to get secret keys from the IMDS service. What URL did the attacker force the server to fetch?

Our previously filtered Wireshark window for `http && ip.src == 18.222.86.32` will show several additional POST requests to `/proc` towards the end. The final entry tries to fetch the IMDS URL http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance.

!!! done "Answer"
    http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance


## Response

!!! quote "Alabaster Snowball"
    Fantastic! It seems simpler now that I've seen it once. Thanks for showing me!<br/>
    Hey, so maybe I can help you out a bit with the door to the mines.<br/>
    First, it'd be great to bring an Elvish keyboard, but if you can't find one, I'm sure other input will do.<br/>
    Next, take a look at the `Content-Security-Policy header`. That drives how certain content is handled.<br/>
    Lastly, remember that input sanitization might happen on either the client or server ends!
