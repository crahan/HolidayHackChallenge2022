# Windows Event Logs

**Difficulty**: :fontawesome-solid-star::fontawesome-solid-star::fontawesome-regular-star::fontawesome-regular-star::fontawesome-regular-star:<br/>
**Direct link**: [eventlog terminal](https://hhc22-wetty.kringlecon.com/?&challenge=eventlogs&id=7bedb8ea-3a55-492f-9cf8-2c76b470cb2e)


## Objective

!!! question "Request"
    Investigate the Windows [event log](https://storage.googleapis.com/hhc22_player_assets/powershell.evtx) mystery in the terminal or offline. Get hints for this challenge by typing `hint` in the upper panel of the Windows Event Logs terminal.

??? quote "Dust Giftwrap"
    Hi! I'm Dusty Giftwrap!<br/>
    We think the Snowrog was attracted to the pungent smell from the baking lembanh.<br/>
    I'm trying to discover which ingredient could be causing such a stench.<br/>
    I think the answer may be in these suspicious logs.<br/>
    I'm focusing on Windows Powershell logs. Do you have much experience there?<br/>
    You can work on this [offline](https://storage.googleapis.com/hhc22_player_assets/powershell.evtx) or try it in this terminal.<br/>
    Golly, I'd apprecaite it if you could take a look.


## Hints

??? hint "Hints"
    1. `grep` is a very useful tool when completing terminal challenges.
    2. Keep [this link](https://linuxcommand.org/lc3_man_pages/grep1.html) handy
    3. Each question may have hints. If you want another hint from the elf, just type `hint` in the upper pane.

??? hint "Built-In hints"
    The hardest steps in this challenge have hints. Just type `hint` in the top panel!

??? hint "Event Logs Expose"
    New to Windows event logs? Get a jump start with [Eric's talk](https://youtu.be/5NZeHYPMXAE)!


## Solution

??? abstract "Welcome message"
    Smilegol successfully downloaded his keylogger and has gathered the admin credentials!<br/>
    We think he used powershell to find the Lembanh recipe and steal our secret ingredient.<br/>
    Luckily, we enabled powershell auditing and have exported the Windows PowerShell logs to a flat text file.<br/>
    Please help me analyze this file and answer my questions.<br/>
    Ready to begin?


NOTE: the questions for this challenge changed during the game. The below answers are for the latest versions.



1. What month/day/year did the attack take place? For example, 09/05/2021.
Use `grep Verbose powershell.evtx.log | cut -d$'\t' -f 2 | cut -d ' ' -f 1 | sort | uniq -c | sort -r` to get the dates from all lines beginning with `Verbose`, count each occurrence, and sort from most to least occurrences. 12/24/2022 appears the most in the log file.
Answer: 12/24/2022


2. An attacker got a secret from a file. What was the original file's name?
PowerShell uses `Get-Content` to retrieve content from a file. A PowerShell variable starts with `$`. So, we can use `grep` with a regular expression string `grep -e '\$.*Get-Content' powershell.evtx.log` to find the entries. All entries show that the file `Recipe` was read from the current folder.

```shell
elf@8736d69c5313:~$ grep -e '\$.*Get-Content' powershell.evtx.log
$foo = Get-Content .\Recipe| % {$_ -replace 'honey', 'fish oil'}
$foo = Get-Content .\Recipe| % {$_-replace 'honey','fish oil'}
$foo = Get-Content .\Recipe| % {$_-replace 'honey','fish oil'}
$foo = Get-Content .\Recipe| % {$_-replace 'honey','fish oil'} $foo | Add-Content -Path 'recipe_updated.txt'
$foo = Get-Content .\Recipe| % {$_ -replace 'honey', 'fish oil'} $foo | Add-Content -Path 'recipe_updated.txt'
```

Answer: `Recipe`


3. The contents of the previous file were retrieved, changed, and stored to a variable by the attacker. This was done multiple times. Submit the last full PowerShell line that performed only these actions.
We can find the activity by searching for lines starting with `$` to indicate the beginning of a variable name. Adding in `replace` to filter things down even further we see the lines ordered from most to least recent. The final command is `grep -E '^\$.*replace' powershell.evtx.log`. The questions asks for a specific set of actions and only those actions, so we can ignore the bottom 2 lines from this output.

```shell
elf@8736d69c5313:~$ grep -e '^\$.*replace' powershell.evtx.log
$foo = Get-Content .\Recipe| % {$_ -replace 'honey', 'fish oil'}
$foo = Get-Content .\Recipe| % {$_-replace 'honey','fish oil'}
$foo = Get-Content .\Recipe| % {$_-replace 'honey','fish oil'}
$foo = Get-Content .\Recipe| % {$_-replace 'honey','fish oil'} $foo | Add-Content -Path 'recipe_updated.txt'
$foo = Get-Content .\Recipe| % {$_ -replace 'honey', 'fish oil'} $foo | Add-Content -Path 'recipe_updated.txt'
```

Answer: `$foo = Get-Content .\Recipe| % {$_ -replace 'honey', 'fish oil'}`


4. After storing the altered file contents into the variable, the attacker used the variable to run a separate command that wrote the modified data to a file. This was done multiple times. Submit the last full PowerShell line that performed only this action.
Adding content to a file in PowerShell is done via `Add-Content` so we use `grep -R '^\$.*Add-Content' powershell.evtx.log` to perform a search that start with the variable name and also contains `Add-Content`. The top line in the result is the most recent log entry.

```shell
elf@8736d69c5313:~$ grep -R '^\$.*Add-Content' powershell.evtx.log
$foo | Add-Content -Path 'Recipe'
$foo | Add-Content -Path 'Recipe.txt'
$foo | Add-Content -Path 'Recipe.txt'
$foo | Add-Content -Path 'Recipe.txt'
$foo | Add-Content -Path 'recipe_updated.txt'
$foo = Get-Content .\Recipe| % {$_-replace 'honey','fish oil'} $foo | Add-Content -Path 'recipe_updated.txt'
$foo = Get-Content .\Recipe| % {$_ -replace 'honey', 'fish oil'} $foo | Add-Content -Path 'recipe_updated.txt'
```

Answer: `$foo | Add-Content -Path 'Recipe'`


5. The attacker ran the previous command against a file multiple times. What is the name of this file?
The output from question 4 also provides the answer to this. The same command was run against `Recipe.txt` multiple times.

Answer: `Recipe.txt`


6. Were any files deleted (Yes/No)?
File deletes in PowerShell are possible using (https://devblogs.microsoft.com/scripting/table-of-basic-powershell-commands/): `Remove-Item`, `ri`, `del`, and `rm`. Searching for `del ` using `grep 'del ' powershell.evtx.log` yields evidence of files being deleted, including `Recipe.txt` and `recipe_updated.txt`.

```shell
elf@8736d69c5313:~$ grep 'del ' powershell.evtx.log
del .\recipe_updated.txt
del .\Recipe.txt
```

Answer: Yes


7. Was the original file (from question 2) deleted? (Yes/No)
Based on the output from question 6original file `Recipe` was not part of the list of files being deleted.

Answer: No


8. What is the Event ID of the log that shows the actual command line used to delete the file?
We can use the previous command and add in `-B 1` to also show the previous line to the one that matches our regular expression, using `grep -B 1 'del ' powershell.evtx.log`. This shows the event ID.

```shell
elf@8736d69c5313:~$ grep -B 1 'del ' powershell.evtx.log
Verbose 12/24/2022 3:05:51 AM   Microsoft-Windows-PowerShell    4104    Execute a Remote Command       "Creating Scriptblock text (1 of 1):
del .\recipe_updated.txt
--
Verbose 12/24/2022 3:05:42 AM   Microsoft-Windows-PowerShell    4104    Execute a Remote Command       "Creating Scriptblock text (1 of 1):
del .\Recipe.txt
```

Answer: 4104


9. Is the secret ingredient compromised (Yes/No)?
Yes, from questions 2 and 3 we know `Recipe` was read and 'honey' was replaced with 'fish oil'. From question 4 we know the modified data stored in the `$foo` variable was then written back to the `Recipe` file. If we grep for `secret` in the `powershell.evtx.log` log file we can see that the entries for the original 'honey' ingredient had '(secret ingredient)' noted beside it.

```shell
lf@8736d69c5313:~$ grep secret powershell.evtx.log
ParameterBinding(Out-Default): name=""InputObject""; value=""1/2 tsp honey (secret ingredient)""
ParameterBinding(Out-Default): name=""InputObject""; value=""1/2 tsp fish oil (secret ingredient)""
ParameterBinding(Add-Content): name=""Value""; value=""1/2 tsp fish oil (secret ingredient)""
ParameterBinding(Add-Content): name=""Value""; value=""1/2 tsp fish oil (secret ingredient)""
ParameterBinding(ForEach-Object): name=""InputObject""; value=""1/2 tsp honey (secret ingredient)""
ParameterBinding(Out-Default): name=""InputObject""; value=""1/2 tsp honey (secret ingredient)""
ParameterBinding(Add-Content): name=""Value""; value=""1/2 tsp fish oil (secret ingredient)""
...
```

Answer: Yes


10.  What is the secret ingredient?
The command output on questions 2 and 3 show that the secret ingredient 'honey' was replaced with 'fish oil'.

Answer: honey


!!! done "Answer"
    See the solution outline above


## Response

!!! quote "Dust Giftwrap"
    Say, you did it! Thanks a million!<br/>
    Now we can mix in the proper ingredients and stop attracting the Snowrog!<br/>
    I'm all set now! Can you help Fitzy over there wield the exalted Suricata?<br/>
    It can be a bit mystifying at first, but this [Suricata Tome](https://suricata.readthedocs.io/en/suricata-6.0.0/rules/intro.html) should help you fathom it.<br/>
    I sure hope you can make it work!
